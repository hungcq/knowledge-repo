# Identity & access management (IAM)
- Global service
- Group: contain users, not group
- 1 user can belong to 0 -> n group
- Policy:
  - JSON doc: define permissions of users/groups
  - -> Least privilege principle: give only the needed permissions
  - Inline policy (vs group policy): for 1 user
  - Variable & tags
  - Components:
    - Version
    - ID
    - Statement:
      - Sid
      - Effect: allow/deny (highest precedence -> use NotAction when don't want Deny)
      - Principal (map): user/account/role
      - Action: array allow/deny actions
      - Resource: array
      - Condition: when to apply. Form: "operator": "key": "value"
- Password policy:
  - Length
  - Specific character types
  - Allow users to change password
  - Password expiration
  - Password reuse prevention
- MFA = password + security device. Types of devices:
  - Virtual (eg Google Auth, Authy)
  - Universal 2nd factor (U2F) security key
  - Hardware key fob
- Access via:
  - Console: use password + MFA
  - CLI: use access key
  - SDK (libs for code): use access key
- Access key: managed by users. Components:
  - ID: ~username
  - Secret: ~password
- Role: short-term credentials, use STS
- -> Assign permissions to services/EC2 instances (via EC2 metadata service)/accounts (via cross-account roles)
- -> Assume role = give up original permissions
- Security tools (for audit):
  - Credentials Report (account level): list users & status of their credentials
  - Access Advisor (user level): service permissions granted & last access of those services
  - Access Analyzer:
    - Analyze resources shared with external entity: define zone of trust (AWS acc/org)
    - -> report findings of access outside zone of trust
    - Policy validation: validate & recommendations
    - Policy generation: cloud trail logs (90 days) -> fine-grained permissions (actions & services)
- Best practices:
  - Root account: created by default, shouldn't be used or shared, except for AWS account setup
  - 1 user ~ 1 person in org
  - Assign users to groups & assign permissions to groups
  - Create strong password policy
  - Use & enforce MFA
  - Use roles to give permissions to services
  - Use access key for programmatic access (CLI/SDK)
  - Audit permissions using security tools
- Cross acc: either:
  - Attach a resource-based policy to a resource (eg S3 bucket policy). Eg services: Lambda, SNS, SQS, CW Logs, API Gateway
  - Use a role as a proxy (assume a role):
    - Give up original permissions & take role's permissions (vs use resource-based policy)
    - Trust Policy: define which principal entities (accounts, users, roles, and federated users) can assume the role
    - -> The only resource-based policy in IAM
    - Eg services: Kinesis stream, Systems Manager Run Command, ECS task
- Permission boundaries:
  - Def: use a managed policy to set the max permissions an IAM entity can get
  - -> Higher precedence over IAM identity-based policy
  - Supported for users & roles (not groups)
  - Can be used in combination with Org. Effective permissions are intersection of boundary & identity-based policy & Org.
  - Use cases:
    - Delegate responsibility to non-admins
    - Allow users to self-manage permissions without escalating their privileges
    - Restrict one specific user of whole acc via SCP
- Access evaluation precedence: deny > Org > resource-based > identity-based > boundary -> session
## Organizations
- Global service, manage multiple AWS accounts
- Acc types:
  - Main: management acc
  - Other: member accs
- Mapping acc:org : n:1
- Hierarchy structure: root organizational unit (OU) -> sub OU -> ... -> member accounts. Can divide by:
  - Business unit
  - Dev/production env
  - Project based
- Security: Service Control Policies (SCP):
  - IAM policies applied to OU/accs
  - Not applied to management acc: root access by default
  - Applied to all users & roles in the acc, including root user
  - Disallow everything by default (vs IAM)
  - Not affect any service-linked role
  - Must have explicit allows in all links from the root to the node acc
- OrganizationAccountAccessRole:
  - Grant full permission in the member acc to the management acc
  - Used to perform admin tasks in the member accounts (eg creating IAM users)
  - Automatically added to newly created member accounts. Need to manually added for invited existing acc.
- Multi account strategies:
  - Per department
  - Per cost center
  - Per dev/test/prod
  - Based on regulatory restrictions
  - For resource isolation
  - Separate per-account service limits
  - Dif account for logging
- Features:
  - Management centralization
  - Consolidated billing across all accs: single payment method
  - -> Pricing benefits from aggregated usage (eg volume discount)
  - Can share reserve instances & saving plans discount across accs
- Reserve instances & saving plans discount:
  - Default share between all accounts
  - Can be turn off by account
  - To have discount, both accounts must turn on
- Move accounts: remove from old org -> invite -> accept
- Policies:
  - Tag Policies: ensure consistent tags. Monitor non-compliance via EventBridge.
  - aws:TagKeys:
    - ForAllValues = AND
    - ForAnyValues = OR
  - awsRequestTag: prevent users/roles in member accounts from creating resources if they don't have tags
  - AI services opt-out policies: AI services can't use content for continuous improvement
  - Backup policies:
    - Define backup plans across org/OU/member acc
    - Immutable backup plans appear in member accounts (view only)
## IAM conditions
- aws:SourceIp: restrict client IP making API calls
- aws:RequestedRegion: restrict region the API calls are made to
- ec2:ResourceTag: restrict based on tags
- aws:MultiFactorAuthPresent: force MFA
- S3:
  - s3:ListBucket: bucket level permission
  - s3:GetObject, s3:PutObject, s3:DeleteObject: object level permission (need to specify path + object/*)
- aws:PrincipalOrgID: used in resource policies to restrict access to accs that are member of an Org
## Identity Center (ex Single Sign-On)
- SSO for:
  - All AWS accs in AWS Orgs
  - Business cloud apps (eg Salesforce, Microsoft 365)
  - SAML 2.0 enabled apps
  - EC2 Windows instances
- Identity providers:
  - Built-in identity store in Identity Center
  - Third party: eg Active Directory, OneLogin, Okta
- Login flow: client -> Identity center: retrieve user identities from providers -> SSO
- Permission Set: collection of IAM policies assigned to users/groups to define AWS access
- Multi acc permissions: manage access across AWS accounts in AWS Org
- Application assignments:
  - SSO access to SAML 2.0 business apps (eg Salesforce, Microsoft 365)
  - Need to provide URLs, certificates, metadata
- Attribute-based access control (ABAC): fine-grained permissions based on users' attributes stored in Identity Store

## Directory Services
- Microsoft Active Directory:
  - Def: DB of objects: users, accs, computers, printers...
  - Flow: Window instances (auth) -> domain controllers
  - Found on Windows Server with AD Domain Services
  - Centralized security management, create acc, assign perms
  - Objects organized in trees. Forest = group of trees.
  - Found on Windows Server with AD Domain Services
- AD Federation Services (ADFS): provide single sign-on across Microsoft apps, using SAML
- Allow creating Microsoft AD on AWS:
  - Managed Microsoft AD:
    - Create AD in AWS
    - Manage users in AWS AD
    - Can establish trust connections with on-premise AD:
      - Must establish Direct connect (DX) or VPN connection
      - 3 types of forest trust:
        - 2 types of 1-way trust
        - 2-way trust
      - Trust ~ proxy != replication
    - Support MFA
    - Features: in slide
    - Highly integrated with AWS services
  - AD Connector:
    - Def: Directory Gateway (proxy) to on-premise AD
    - Support MFA
    - Users managed on on-premise AD
    - Need VPN/DX
    - No caching
  - Simple AD:
    - Managed AD on AWS, can't be joined with on-premise AD
    - Cheap, small scale, less features
- Identity Center - Active Dir setup:
  - Managed AD: out of the box integration
  - Self-managed AD: either:
    - Create 2-way trust rela using Managed AD
    - Create AD Connector

## Control Tower
- Def: easy way to set up & govern a secure & compliant multi-acc AWS env based on best practices
- Use Org to create accs
- Guardrails:
  - Provide ongoing gov of Control Tower env (AWS accs)
  - 2 types:
    - Preventive Guardrail: use SCP (eg restrict regions across all accs)
    - Detective: use Config to monitor compliance
  - Levels:
    - Mandatory: auto enabled & enforced by Control Tower
    - Strongly recommended: based on AWS best practices
    - Elective: commonly used by enterprises (optional)
- Account Factory: automate account provisioning & deployments:
  - Pre-approved baselines & config options (eg VPC default config)
  - Provision new accs via AWS Service Catalog 

## Security token service (STS)
- User (assume role API) -> STS: credentials (15m-12h)
- Need to grant permission to assume a role
- Can revoke active sessions
- Can add MFA protection to role: only users signing in with MFA can assume the role
- Grant access to third party (AWS account outside zone of trust):
  - Get 3rd party AWS acc ID
  - Define external ID (secret between 2 parties, rela: third party 1:1 role)
- Session tag: provide when assuming a role -> added in the credentials -> used for authorization in IAM policy
- APIs:
  - AssumeRole
  - AssumeRoleWithSAML: for users logged in with SAML
  - AssumeRoleWithWebIdentity: for users logged in with internet identity provider (eg Google, FB)
  - -> Should use Cognito instead
  - GetSessionToken: for MFA
  - GetFederationToken: for federated user

## Identity federation
- Def: give users outside AWS permissions to access AWS resources in your account
- -> Don't need to create IAM users
- Types:
  - SAML 2.0: user -> auth & get SAML assertion (key) via identity store
  -> AWS SAML sign in endpoint/AssumeRoleWithSAML -> credentials
  - Custom identity broker application:
    - For identity provider not compatible with SAML 2.0
    - Flow: user -> identity broker -> auth with identity store + call STS AssumeRole/GetFederationToken -> credentials
  - Web identity federation:
    - Without Cognito (not recommended): user: 1. IDP -> web token, 2. STS -> credentials
    - With Cognito (~token vending machine):
      - Flow: user: 2. Cognito -> Cognito token, 3. STS -> credentials
      - Advs:
        - Support anonymous users
        - Support MFA
        - Data sync

## Resource Access Manager (RAM)
- Share AWS resources you own with other accounts or within Org
- Resources can be shared:
  - VPC subnets:
    - Allow to have all resources launched in the same subnets
    - Must be from the same AWS org
    - Can't share security groups & default VPC
    - Participants can manage their own resources, but can't view, modify, delete resources of others
  - Transit Gateway
  - Route 53 (Resolver Rules, DNS Firewall Rule Groups)
  - ...
- Managed Prefix List:
  - Def: a set of 1+ CIDR blocks
  - Make it easier to config & maintain security groups & route tables
  - Customer-managed prefix list: share with other accounts: update to modify many security groups at once
  - AWS-managed prefix list: set of CIDRs for AWS services, can't be CRUD
- Route 53 Outbound Resolver:
  - Share forwarding rules with other accs with VPCs
  - Define forwarding rules (DNS A record) -> share with other accounts -> can forward to IP of VPC of other accounts