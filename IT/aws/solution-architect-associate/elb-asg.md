# Availability & scalability: ELB & ASG
- ELB:
  - Managed & maintained by AWS, few config provided
  - Highly integrated with other AWS services
  - Health check at target group level
  - Can be setup as internal (private) or external (public)
  - Use security group
  - Scope: regional
  - Types:
    - Classic (old generation) - not tested: HTTP, HTTPS, TCP, SSL
    - Application: HTTP, HTTPS, web socket:
      - Support LB across target groups:
        - EC2 instances: autoscaling group
        - ECS tasks: HTTP apps/containers within same machine, managed by ECS
        - Lambda functions: translate HTTP request into JSON event
        - Private IP addresses
      - Routing based on:
        - Hostname
        - Path
        - Query
        - Header
      - Has port mapping feature to work with dynamic port
    - Network (layer 4): TCP, TLS, UDP:
      - Higher load, lower latency
      - Has 1 static IP per AZ -> easy to whitelist, support elastic IP
      - Target groups:
        - EC2 instances
        - Private IP addresses
        - Application load balancer
      - Health check supports:
        - TCP
        - HTTP, HTTPS: when target is ALB
    - Gateway (layer 3 - network layer - IP protocol):
      - Act as gateway (eg firewall, traffic inspection purpose)
      - Use case: deploy, manage, scale a fleet of virtual appliances on AWS
      - Traffic path: users -> gateway LB -> target group of virtual appliances (analyze traffic) -> gateway LB -> apps
      - Functions:
        - Transparent network gateway
        - Load balancing
      - Use GENEVE protocol on port 6081
      - Target groups:
        - EC2 instances
        - Private IPs
- Sticky sessions (session affinity):
  - Def: same client to the same instance
  - Work for: classic, app & network LB
  - Mechanism: cookies with custom expiration
  - Cookies types:
    - Application-based:
      - Custom: generated by target, must be specified individually for each target group
      - App: generated by load balancer. Name: AWSALBAPP.
    - Duration-based: generated by LB. Name: AWSALB, AWSCLB
- Cross-zone LB:
  - Distribute traffic evenly across all instances in all AZs
  - -> Without it: distribute evenly across AZs
  - App/classic: enabled/disabled by default, not charged for inter AZ traffic
  - Network/gateway LB: disabled by default, charged for inter AZ traffic
- SSL:
  - Clients can use SNI (server name indication) to specify host name they reach -> server select the correct cert
  - -> Allow loading multiple SSL certs into 1 server -> support multiple listeners with multiple SSL certs
  - -> Only work for ALB, NLB, cloud front
- Connection draining (de-registration delay):
  - Def: time to complete in-flight request when the instance is de-registering or unhealthy
  - -> Stop sending new requests to the unhealthy instance
  - Set to low value if requests are short
- ASG (autoscaling group):
  - Add/remove instance to match increasing/decreasing load
  - Can have min/desired/max instances
  - Auto register new instances to the LB
  - Auto terminate instances marked as unhealthy by LB
  - Auto create new instance when one is terminated (eg unhealthy)
  - Attributes:
    - Launch template (~when create new EC2 instances)
    - Min, max & initial capacity
    - Scaling policies:
      - Dynamic:
        - Target tracking (eg 40% average CPU)
        - Simple/step scaling (eg when an alarm is trigger, add/remove x instances)
        - Scheduled action (eg increase min capacity to x at 10pm Fridays)
      - Predictive: analyze historical load -> generate forecast -> schedule scaling actions
  - Scaling metrics:
    - Average CPU
    - Request count per target
    - Average network in/out: if app is network bound
    - Custom metric
  - Scaling cooldown: period of not launching/terminating new instances after a scaling action
  - -> Allow metrics to stabilize
  - Can be triggered via Cloud watch alarm (eg for average CPU metric)
  - Should use ready to use AMI for faster setup